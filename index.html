<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Note Share</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f5f6fa;
  color:#000;
}

.page{max-width:800px;margin:auto;padding:15px}

.card{
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

input,textarea,button{
  width:100%;
  margin:6px 0;
  padding:12px;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:16px;
}

textarea{
  min-height:300px;
  resize:none;
}

button{
  background:#007bff;
  color:#fff;
  border:none;
  font-weight:bold;
  cursor:pointer;
}

button:hover{opacity:.9}

.note-content{
  background:#f7f7f7;
  padding:15px;
  border-radius:10px;
  white-space:pre-wrap;
  word-wrap:break-word;
}

.note-content a{
  color:#007bff;
  word-break:break-all;
}

.small{font-size:12px;color:#777}

.help-btn{
  display:block;
  margin-top:15px;
  padding:14px;
  text-align:center;
  background:#ff4757;
  color:#fff;
  border-radius:10px;
  font-weight:bold;
  text-decoration:none;
}
.help-btn:hover{opacity:.9}
</style>
</head>

<body>

<div class="page" id="createPage">
  <div class="card" id="accountBox">
    <h3>T√™n hi·ªÉn th·ªã</h3>
    <input id="nameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
    <button onclick="saveName()">L∆∞u</button>
  </div>

  <div class="card">
    <input id="title" placeholder="Ti√™u ƒë·ªÅ note">
    <textarea id="content" placeholder="Nh·∫≠p n·ªôi dung (d√°n link tho·∫£i m√°i)"></textarea>
    <input id="supportLink" placeholder="Link h·ªó tr·ª£ (Zalo / TikTok / Facebook‚Ä¶)">
    <button onclick="createLink()">üîó T·∫°o link</button>
  </div>

  <div class="card">
    <h3>Note ƒë√£ t·∫°o <button onclick="clearAllNotes()" style="background:#dc3545;padding:5px 10px;font-size:12px;float:right">X√≥a t·∫•t c·∫£</button></h3>
    <div id="myLinks" class="small">Ch∆∞a c√≥</div>
  </div>
</div>

<div class="page" id="viewPage" style="display:none">
  <div class="card">
    <h2 id="viewTitle"></h2>
    <div id="viewContent" class="note-content"></div>
    <a id="helpBtn" class="help-btn" target="_blank">
      ‚ùó C√≥ l·ªói / Link l·ªói ‚Äì Nh·∫•n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£
    </a>
    <div style="text-align:center;margin-top:20px;">
      <button onclick="window.location.href='?'" style="background:#6c757d;padding:10px 20px;">
        ‚Üê T·∫°o note m·ªõi
      </button>
    </div>
  </div>
</div>

<script>
// ===== KH·ªûI T·∫†O =====
const NOTES_STORAGE = "noteShare_notes";
const LINKS_STORAGE = "noteShare_links";

let userName = localStorage.getItem("uname") || "";
let myNotes = JSON.parse(localStorage.getItem(LINKS_STORAGE) || "[]");

// ===== KH·ªûI CH·∫†Y =====
document.addEventListener('DOMContentLoaded', function() {
  if (userName) {
    accountBox.style.display = "none";
    nameInput.value = userName;
  }
  
  const params = new URLSearchParams(location.search);
  const noteId = params.get("id");
  
  if (noteId) {
    loadNoteById(noteId);
  } else {
    renderMyLinks();
  }
});

// ===== USER =====
function saveName() {
  const n = nameInput.value.trim();
  if (!n) return alert("Nh·∫≠p t√™n");
  localStorage.setItem("uname", n);
  userName = n;
  accountBox.style.display = "none";
  alert("ƒê√£ l∆∞u t√™n!");
}

// ===== T·∫†O NOTE M·ªöI =====
function createLink() {
  if (!userName) {
    alert("Ch∆∞a c√≥ t√™n");
    accountBox.style.display = "block";
    return;
  }

  const t = title.value.trim();
  const c = content.value.trim();
  const s = supportLink.value.trim();

  if (!t || !c) {
    alert("Thi·∫øu n·ªôi dung");
    return;
  }

  // T·∫°o ID ng·∫Øn duy nh·∫•t
  const noteId = generateShortId();
  
  const note = {
    id: noteId,
    title: t,
    content: c,
    owner: userName,
    support: s,
    created: Date.now()
  };

  // L∆∞u note v√†o storage
  saveNoteToStorage(note);
  
  // T·∫°o link ng·∫Øn v·ªõi ID
  const base = location.href.split("?")[0].split("#")[0];
  const link = base + "?id=" + noteId;
  
  // L∆∞u v√†o l·ªãch s·ª≠
  myNotes.unshift({
    id: noteId,
    title: t,
    link: link,
    time: new Date().toLocaleString('vi-VN')
  });
  
  // Gi·ªõi h·∫°n 100 note g·∫ßn nh·∫•t
  if (myNotes.length > 100) {
    myNotes = myNotes.slice(0, 100);
  }
  
  localStorage.setItem(LINKS_STORAGE, JSON.stringify(myNotes));
  
  // Copy link
  copyToClipboard(link, "‚úÖ ƒê√£ t·∫°o v√† copy link!\n\nID: " + noteId);
  
  // Reset form
  title.value = '';
  content.value = '';
  supportLink.value = '';
  
  renderMyLinks();
}

// ===== T·∫¢I NOTE T·ª™ ID =====
function loadNoteById(noteId) {
  try {
    const allNotes = JSON.parse(localStorage.getItem(NOTES_STORAGE) || "{}");
    const note = allNotes[noteId];
    
    if (!note) {
      throw new Error("Note kh√¥ng t·ªìn t·∫°i");
    }
    
    // Hi·ªÉn th·ªã note
    createPage.style.display = "none";
    viewPage.style.display = "block";
    
    viewTitle.innerHTML = `
      ${note.title || 'Kh√¥ng ti√™u ƒë·ªÅ'}
      <div class="small">‚úç ${note.owner || '·∫®n danh'} | ID: ${noteId}</div>
    `;
    
    // X·ª≠ l√Ω content ƒë√∫ng th·ª© t·ª±
    let content = note.content || '';
    content = autoLink(content);
    content = content.replace(/\n/g, '<br>');
    viewContent.innerHTML = content;
    
    // Link h·ªó tr·ª£
    if (note.support && note.support.trim()) {
      let supportLink = note.support.trim();
      if (!supportLink.startsWith('http://') && !supportLink.startsWith('https://')) {
        supportLink = 'https://' + supportLink;
      }
      helpBtn.href = supportLink;
      helpBtn.style.display = "block";
    } else {
      helpBtn.style.display = "none";
    }
    
    // Th√™m v√†o l·ªãch s·ª≠ n·∫øu ch∆∞a c√≥
    addToHistoryIfNotExists(noteId, note.title);
    
  } catch (error) {
    console.error("L·ªói t·∫£i note:", error);
    createPage.style.display = "none";
    viewPage.style.display = "block";
    viewTitle.textContent = "‚ùå L·ªói";
    viewContent.innerHTML = `
      <div style="text-align:center; padding:30px; color:#666">
        <h3>Kh√¥ng th·ªÉ t·∫£i note</h3>
        <p>Note n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c kh√¥ng t·ªìn t·∫°i.</p>
        <p><strong>ID:</strong> ${noteId}</p>
        <button onclick="window.location.href='?'" style="margin-top:20px; padding:10px 20px;">
          ‚Üê Quay l·∫°i
        </button>
      </div>
    `;
    helpBtn.style.display = "none";
  }
}

// ===== TI·ªÜN √çCH =====
function generateShortId() {
  // T·∫°o ID ng·∫Øn: timestamp + random string
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function saveNoteToStorage(note) {
  const allNotes = JSON.parse(localStorage.getItem(NOTES_STORAGE) || "{}");
  allNotes[note.id] = note;
  localStorage.setItem(NOTES_STORAGE, JSON.stringify(allNotes));
}

function addToHistoryIfNotExists(noteId, title) {
  const exists = myNotes.some(note => note.id === noteId);
  if (!exists && title) {
    const base = location.href.split("?")[0].split("#")[0];
    const link = base + "?id=" + noteId;
    
    myNotes.unshift({
      id: noteId,
      title: title,
      link: link,
      time: new Date().toLocaleString('vi-VN')
    });
    
    if (myNotes.length > 100) {
      myNotes = myNotes.slice(0, 100);
    }
    
    localStorage.setItem(LINKS_STORAGE, JSON.stringify(myNotes));
  }
}

function autoLink(text) {
  if (!text) return '';
  
  // Escape HTML tr∆∞·ªõc
  let escaped = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
  
  // Link h√≥a URL sau khi escape
  const urlRegex = /(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/gi;
  return escaped.replace(urlRegex, function(match) {
    // Decode t·∫°m ƒë·ªÉ l·∫•y URL ƒë√∫ng cho href
    const cleanUrl = match
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#039;/g, "'");
    return `<a href="${cleanUrl}" target="_blank" rel="noopener">${match}</a>`;
  });
}

function copyToClipboard(text, message) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      alert(message || "‚úÖ ƒê√£ copy!");
    }).catch(() => {
      copyFallback(text, message);
    });
  } else {
    copyFallback(text, message);
  }
}

function copyFallback(text, message) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    document.execCommand('copy');
    alert(message || "‚úÖ ƒê√£ copy!");
  } catch (err) {
    prompt("Copy link th·ªß c√¥ng:", text);
  }
  
  document.body.removeChild(textarea);
}

function renderMyLinks() {
  if (!myNotes || myNotes.length === 0) {
    myLinks.innerHTML = '<p style="color:#666;text-align:center">Ch∆∞a c√≥ note n√†o</p>';
    return;
  }
  
  myLinks.innerHTML = myNotes.map((note, index) => `
    <div style="margin:10px 0; padding:10px; background:#f9f9f9; border-radius:8px; border-left:3px solid #007bff;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${index + 1}. ${note.title || 'Kh√¥ng ti√™u ƒë·ªÅ'}</strong>
          <div style="font-size:11px; color:#666; margin-top:3px;">
            üïí ${note.time} | ID: ${note.id.substring(0, 8)}...
          </div>
        </div>
        <div>
          <button onclick="copyToClipboard('${note.link}', '‚úÖ ƒê√£ copy link!')" style="background:#28a745; padding:5px 10px; font-size:12px; margin-right:5px;">
            üìã
          </button>
          <button onclick="deleteNote('${note.id}')" style="background:#dc3545; padding:5px 10px; font-size:12px;">
            üóëÔ∏è
          </button>
        </div>
      </div>
      <div style="margin-top:8px; word-break:break-all; font-size:12px;">
        <a href="${note.link}">${note.link}</a>
      </div>
    </div>
  `).join('');
}

function deleteNote(noteId) {
  if (!confirm("X√≥a note n√†y?\nL∆∞u √Ω: Link chia s·∫ª s·∫Ω kh√¥ng ho·∫°t ƒë·ªông n·ªØa.")) return;
  
  // X√≥a kh·ªèi l·ªãch s·ª≠
  myNotes = myNotes.filter(note => note.id !== noteId);
  localStorage.setItem(LINKS_STORAGE, JSON.stringify(myNotes));
  
  // X√≥a kh·ªèi storage
  const allNotes = JSON.parse(localStorage.getItem(NOTES_STORAGE) || "{}");
  delete allNotes[noteId];
  localStorage.setItem(NOTES_STORAGE, JSON.stringify(allNotes));
  
  renderMyLinks();
  alert("ƒê√£ x√≥a note!");
}

function clearAllNotes() {
  if (!confirm("X√ìA T·∫§T C·∫¢ NOTE?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a m·ªçi note v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!")) return;
  
  localStorage.removeItem(NOTES_STORAGE);
  localStorage.removeItem(LINKS_STORAGE);
  myNotes = [];
  
  renderMyLinks();
  alert("ƒê√£ x√≥a t·∫•t c·∫£ note!");
}

// ===== TH√äM C·∫¢NH B√ÅO =====
window.addEventListener('load', function() {
  // Hi·ªÉn th·ªã th√¥ng tin
  const allNotes = JSON.parse(localStorage.getItem(NOTES_STORAGE) || "{}");
  const noteCount = Object.keys(allNotes).length;
  
  if (noteCount > 0) {
    console.log(`ƒêang l∆∞u ${noteCount} note trong b·ªô nh·ªõ`);
  }
  
  // C·∫£nh b√°o v·ªÅ localStorage
  if (location.protocol === 'file:') {
    const warning = document.createElement('div');
    warning.innerHTML = `
      <div style="background:#fff3cd; border:1px solid #ffc107; border-radius:8px; padding:10px; margin:10px 0; color:#856404;">
        <strong>‚ö† L∆∞u √Ω:</strong> Note ƒë∆∞·ª£c l∆∞u tr√™n m√°y n√†y. Chia s·∫ª link ch·ªâ ho·∫°t ƒë·ªông tr√™n c√πng m√°y/tr√¨nh duy·ªát.
      </div>
    `;
    
    const firstCard = document.querySelector('.card');
    if (firstCard) {
      firstCard.parentNode.insertBefore(warning, firstCard);
    }
  }
});
</script>
</body>
</html>